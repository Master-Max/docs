************************************************************
1С УТ 11.1: Как настроить обмен данными c интернет-магазином
************************************************************

Инструкция по обмену данными в формате CommerceML между 1С "Управление Торговлей" 11.1 и интернет-магазином на платформе CS-Cart или маркетплейсом на платформе Multi-Vendor.

.. important::

    У 1С много разных версий и конфигураций, которые могут выглядеть по-разному. Поэтому мы на примере одной из версий описываем общий принцип настройки, чтобы вы по аналогии могли настроить свою версию 1C. Если там нет какого-то элемента управления или сильно отличается внешний вид, рекомендуем обратиться в техподдержку 1С.

.. contents::
    :local: 
    :depth: 2


Шаг 1. Подключение 1С УТ 11.1 к CS-Cart или Multi-Vendor
========================================================

Обмен данными запускается со стороны 1С, через так называемый узел обмена данными. Поэтому сначала нужно настроить этот узел и подключить к магазину.


1.1. Задайте настройки
----------------------

#. В 1С зайдите в "Администрирование" и нажмите на ссылку "Настройки синхронизации данных". В окне "Настройки синхронизации данных" включите "Обмен данными с сайтами".

   .. fancybox:: img/1Cimage_4.png
       :alt: Обмен данными 1C и CS-Cart

#. Нажмите на ссылку "Общие настройки" и включите "Дополнительные реквизиты и сведения".

   .. fancybox:: img/1Cimage_5.png
       :alt: Обмен данными 1C и CS-Cart

#. Нажмите на ссылку "CRM и продажи" в левом меню и включите "Заказы клиентов" в появившейся форме.

   .. fancybox:: img/1Cimage_6.png
       :alt: Обмен данными 1C и CS-Cart


1.2. Создайте типовое соглашение с клиентами
--------------------------------------------

#. Пройдите в раздел "Маркетинг и планирование" и нажмите на ссылку "Типовые соглашения с клиентами".

#. В окне "Типовые соглашения об условиях продаж" нажмите на кнопку "Создать".

   .. fancybox:: img/1Cimage_7.png
       :alt: Обмен данными 1C и CS-Cart

#. В новом окне "Типовое соглашение об условиях продаж" заполните все неоходимые поля, при этом:

   * поле "Статус" должно иметь значение "Действует";

   * поле "Сегмент партнеров" должно быть пустым;

   * поле "Доступно внешним пользователем" должно быть отмечено галочкой.

     .. fancybox:: img/1Cimage_8.png
         :alt: Обмен данными 1C и CS-Cart


1.3. Создайте новый узел обмена
-------------------------------

#. Пройдите в "Администрирование" и нажмите на ссылку "Настройки синхронизации данных". В окне "Настройки синхронизации данных" нажмите на ссылку "Узлы обмена с сайтами" и создайте новый узел.

    .. fancybox:: img/1Cimage_9.png
        :alt: Обмен данными 1C и CS-Cart

#. В окне создания нового узла необходимо настроить процесс обмена.

   * Во вкладке **"Основные настройки"** узла обмена заполните следующие поля:

     .. fancybox:: img/1Cimage_10.png
         :alt: Обмен данными 1C и CS-Cart

     .. list-table::
         :widths: 10 30

         *   - Наименование

             - Введите наименование обмена

         *   - "Режим обмена данными"

             - * "Выгрузка товаров", если планируется выгрузка товаров на сайт;

               * "Обмен заказами", если планируется загрузка и выгрузка заказов.

         *   - Выберите назначение обмена

             - * "Выгружать на сайт" — для выгрузки данных на сайт.

                 Если выбрано данное назначение, то в поле "Адрес сайта" введите путь к скрипту, который будет обрабатывать обмен. Его можно увидеть в настройках обмена на стороне CS-Cart; обычно он выглядит наподобие https://example.com/commerceml.

                 Также необходимо ввести имя пользователя интернет-магазина и его пароль.

                 Для проверки соединения нажмите кнопку "Проверить соединение". Если все параметры заполнены корректно, появится сообщение "Соединение успешно установлено". В противном случае проверьте правильность введённого адреса и параметров доступа.

                 .. important::

                     Если проверка соединения проходит неудачно, обмен работать не будет.

                 В процессе обмена товарам, загруженным из 1С в поле "Магазин", будет записано название магазина, имя и пароль администратора которого указано в настройках узла обмена в 1С.

               * "Выгружать в каталог на диске" — для выгрузки данных в файл. 

                 Если выбрано данное назначение, то необходимо указать путь к каталогу, куда будут выгружаться данные.

         *   - "Использовать периодический обмен данными"

             - Для автоматического обмена данными включите "Использовать периодический обмен данными" и настройте расписание обмена, чтобы обмен запускался автоматически, когда это необходимо.

               .. fancybox:: img/1Cimage_11.png
                   :alt: Обмен данными 1C и CS-Cart

   * Вкладка **"Выгрузка товаров"** доступна и видна, если включен флажок "Выгрузка товаров" на вкладке **"Основные настройки"**. Заполните там поля:

     .. fancybox:: img/1Cimage_12.png
         :alt: Обмен данными 1C и CS-Cart

     .. list-table::
         :widths: 15 30

         *   - Организация-владелец каталога товаров

             - Это организация, от имени которой будет производиться обмен.

         *   - Выгружаемые данные

             - * Каталог товаров.

               * Файлы изображений — будут выгружаться изображения товаров.

               * Прочие файлы — будут выгружаться присоединённые файлы товаров.

               * Классифицировать по видам номенклатуры — категории товаров будут выгружаться из справочника "Виды номенклатуры". Если настройка выключена, категории будут выгружаться из справочника "Номенклатура".

               * Цены по соглашениям и остатки товаров на складах.

               * Склады доступные для выбора на сайте.
    
         *   - Выберите режим выгрузки данных:

             - * "Все данные" — выгрузка всех товаров и заказов, соответствующих условиям выгрузки.

               * "Изменения" — выгрузка объектов, измененных с момента последней удачной выгрузки.

         *   - Таблица каталогов

             - В данной таблице можно указать отбор данных выгружаемых на сайт.

     **Настройки "Таблицы каталогов"**

     * В колонке "Каталог" задается имя каталога, 

     * В колонке "Группы номенклатуры" настраивается фильтр выгрузки групп (состав выбираемых групп зависит от установки флажка "Классифицировать по видам номенклатуры"): 

       - Если флажок "Классифицировать по видам номенклатуры" включен, то группы выбираются из справочника "Виды номенклатуры", иначе — из справочника "Номенклатура".

       - Если группы не выбраны, то выгружаться будут все группы. В колонке "Идентификатор каталога" задается идентификатор, по которому устанавливается связь выгружаемых данных с конкретными категориями в интернет-магазине.

     * Для настройки отбора выберите колонку "Отбор" в таблице каталогов. В форме настройки отбора установите ограничения по выгрузке товаров. 

     .. fancybox:: img/1Cimage_13.png
         :alt: Обмен данными 1C и CS-Cart

   * Вкладка "Обмен заказами" доступна и видна, если включен флажок "Обмен заказами" на вкладке "Основные настройки". Она содержит два раздела "Параметры обмена заказами" и "Дополнительно".

     В разделе **"Основные настройки обмена заказами"** заполните следующие поля:

     .. fancybox:: img/1Cimage_14.png
         :alt: Обмен данными 1C и CS-Cart

     * Заполните поля "Дата заказа на сайте" и "Номер заказа на сайте", по которым будет осуществляться поиск заказов с сайта.

       .. important::

           Для добавления значений, используемых в полях "Дата заказа на сайте" и "Номер заказа на сайте", откройте "Общие настройки". В окне общих настроек нажмите на ссылку "Дополнительные реквизиты". В окне дополнительные реквизиты в левом окне выберите "Заказ клиента" и добавьте дополнительные реквизиты.

     * В поле "Соглашение" выберите ранее созданное типовое соглашение с клиентами.

     * В поле "Организация" выберите организацию, от имени которой будет создаваться документ "Заказ клиента".

     * В поле "Склад" укажите склад, который будет использоваться в документе "Заказ клиента".

     * Заполните поле "Менеджер"; от его имени будут создаваться документы "Заказ клиента".

     * Выберите "Способ поиска существующих элементов справочника Контрагенты" для поиска контрагентов при загрузке заказов с сайта. Есть 2 варианта поиска: по наименованию и по комбинации ИНН+КПП. В обмене данными для CS-Cart необходимо использовать вариант "По наименованию".

     * Укажите "Вид номенклатуры для товаров" — вид номенклатуры, с которым будут записываться новые товары, загруженные с сайта.

     * Укажите "Вид номенклатуры для услуг" — вид номенклатуры, с которым будут записываться новые услуги, загруженные с сайта.

     * Выберите "Единица измерения" — единица измерения, с которой будут записываться новые товары с сайта.

     * Укажите "Группа номенклатуры" — группа, в которую будут записываться товары с сайта.

     * В поле "Комментарий" добавьте комментарий к документу "Заказ клиента", если это необходимо.

     В разделе **"Дополнительно"** можно настроить дополнительные параметры обмена заказами:

     .. fancybox:: img/1Cimage_15.png
        :alt: Обмен данными 1C и CS-Cart

     * "Статус заказа Отменен на сайте" — устанавливает статус заказа в случае, если он "Отменен".

     * "Причина отмены заказа" — устанавливает причину присваиваемому заказу, если его статус "Отменен".

     * "Соответствие статусов заказов в информационной базе и на сайте" — настраивает соответствие статусов заказа на сайте статусам документа "Заказ клиента" в 1С. Если такие соответствия настроены, то при загрузке заказов будет происходить попытка установки соответствующего статуса документам "Заказ клиента".

#. После настройки всех необходимых параметров выгрузки сохраните узел, нажав на кнопку "Записать и закрыть".


Шаг 2. Настройка на стороне CS-Cart и Multi-Vendor
==================================================

Запустите обмен на стороне 1С. Когда 1С отправляет данные в CS-Cart или в Multi-Vendor в первый раз, то никакие товары ещё не создаются. Чтобы создавались, сначала нужно :doc:`задать соответствия и настройки на стороне CS-Cart </user_guide/addons/commerceml/index>`. Данные в CS-Cart начнут создаваться только после того, как будет задано хотя бы одно соответствие для каждой из нужных сущностей.

.. fancybox:: /user_guide/addons/commerceml/img/commerceml-checklist.png
    :alt: Список сущностей, для которых нужно задать соответствия в CS-Cart


Шаг 3. Запуск регулярного обмена данными между 1C УТ 11.1 и магазином
=====================================================================

После того, как CS-Cart настроен, последующие обмены с 1С начнут создавать в нём данные. Осталось только регулярно их выполнять. Обмен данными между 1С и CS-Cart можно осуществлять одним из способов:

* Автоматический запуск
    
  Для автоматического запуска обмена достаточно настроить расписание автоматического обмена данными в форме узла обмена данными.

* Ручной запуск

  Для запуска обмена данными откройте созданный узел обмена и нажмите на кнопку "Выполнить обмен". Будет запущен процесс обмена, по окончании которого будет выдано соответствующее сообщение.

.. fancybox:: img/1Cimage_26.png
   :alt: Обмен данными 1C и CS-Cart

Для анализа результатов обмена используется журнал регистрации «1С: Предприятия». Для просмотра событий выгрузки данных в окне созданного узла обмена необходимо нажать кнопку "Все действия" → "События выгрузки данных". Откроется окно "Журнал регистрации".
    
.. fancybox:: img/1Cimage_27.png
    :alt: Обмен данными 1C и CS-Cart
    
В форме "Журнал регистрации" для просмотра истории обмена открываются строки журнала и анализируется содержащаяся в них информация. Для быстрого просмотра протокола обмена по строке журнала достаточно нажать на поле "Комментарий", и откроется окно "Событие":
    
.. fancybox:: img/1Cimage_28.png
    :alt: Обмен данными 1C и CS-Cart
    
Для просмотра и удаления объектов, зарегистрированных для выгрузки, в окне созданного узла обмена нажмите на кнопку "Все действия" → "Показать зарегистрированные изменения". В форме отображаются группы (виды) объектов: Товары, Файлы и Заказы. Если необходимо отменить (удалить) регистрацию конкретного объекта, необходимо выбрать его и нажать на кнопку [x]:
    
.. fancybox:: img/1Cimage_29.png
    :alt: Обмен данными 1C и CS-Cart