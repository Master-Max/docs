***********************************
FAQ: Как работают магазины и склады
***********************************

.. contents::
    :local:

==============================
Как создать магазин или склад?
==============================

Магазины и склады основаны на пунктах самовывоза. Чтобы создать склад, выберите соответствующий тип :doc:`в настройках пункта самовывоза </user_guide/shipping_and_taxes/shipping_methods/realtime_shipping_methods/pickup>`: "пункт самовывоза", "магазин" и "склад". 

.. fancybox:: img/point_type.png
    :alt: Выбор типа пункта самовывоза в настройках CS-Cart.

.. hint::
    Сначала убедитесь, что у вас в магазине :doc:`установлен и включен </user_guide/addons/1manage_addons>` модуль :doc:`"Склады" <index>`. Иначе вы не сможете выбрать тип.

======================================
Чем отличаются ПВЗ, магазины и склады?
======================================

.. list-table::
    :header-rows: 1
    :widths: 9 6 4 4

    *   -   
        -   Пункт самовывоза
        -   Магазин
        -   Склад
    *   -   Отсюда возможен самовывоз*
        -   ✓
        -   ✓
        -   
    *   -   Отображается на странице товара
        -   
        -   ✓
        -   
    *   -   Здесь хранится товар
        -   
        -   ✓
        -   ✓

\* Т.е. эта точка отображается при оформлении заказа самовывозом и на карте ``index.php?dispatch=store_locator.search``.

==============================================
За что отвечают настройки магазинов и складов?
==============================================

На вкладке "Настройки" можно указать, где находится точка и с какими :doc:`тарифными зонами </user_guide/shipping_and_taxes/locations/index>` работает:

* **Находится в тарифной зоне** — где физически находится точка. Для магазинов и пунктов самовывоза по этому параметру определяется стоимость и срок доставки, если их выбрать при самовывозе.

* **Показывать в** *(только у магазинов и пунктов самовывоза)* — в каких тарифных зонах точка отобразится покупателям и будет предложена для самовывоза.

  Например, если у вас точки в Москве и Санкт-Петербурге, то жителям каждого города имеет смысл предлагать магазины и ПВЗ в их городе.

* **Доставка в** *(только у магазинов и складов)* — в какие тарифные зоны вы можете отправить товар с этой точки.

  Если товар в наличии только на точке, с которой вы не отправляете в какую-нибудь тарифную зону, то для покупателей из той зоны товар будет отсутствовать в наличии.

  Когда магазин или склад доставляет в тарифную зону, появляется несколько дополнительных настроек:

  * **Срок перевозки** — время, за которое товар попадёт с этой точки на любой магазин или склад в этой тарифной зоне.

    .. important::

        Если в тарифной зоне есть хотя бы один магазин (или вы предупреждаете покупателей о задержке), то обязательно укажите срок перевозки. Иначе покупатели не узнают, в наличии ли товар, и как скоро он прибудет.

    Например, если у вас несколько магазинов в Москве, то "срок перевозки" — это время, за которое товар попадёт с этой точки на любой из них. Если в магазине нет товара в наличии, то покупатель узнает, как скоро вы сможете его подвезти со склада или другого магазина при заказе.

    Значение этой настройки будет вставляться в следующие фразы:

    * *При заказе:* ``[value]``

    * *Товар на удалённом складе. Если вы его закажете, мы отправим его* ``[value]``.

      Поэтому подойдут варианты ``через 3 часа``, ``завтра`` и т.п. Если хотите, то фразы можно поменять :doc:`через языковые переменные </user_guide/look_and_feel/languages/translate>`.

  * **Предупреждать о задержке** — показывать срок перевозки на списке товаров, странице товара и в корзине, если нужно везти товар с этой точки.

    Эта настройка полезна, когда вы работаете с поставщиком, который подвозит вам товар не сразу. Когда товар заканчивается у вас, но ещё есть у поставщика, то покупатель увидит, что вам понадобится дополнительное время на отправку.

  .. fancybox:: img/warehouse_settings.png
      :alt: Настройки магазинов и складов в CS-Cart.
      
=======================================================
Как происходит обмен по CommerceML при многоскладовости
=======================================================

Если включен модуль "Склады", то в настройках обмена из модуля :doc:`CommerceML </user_guide/addons/commerceml/index>` появится вкладка **Склады**. Она позволяет задать соответствие между этим магазином/складом в CS-Cart и в файле *offers.xml*:

* Если соответствие задано, то данные со склада с таким ID из *offers.xml* попадут в соответствующий склад в CS-Cart.

* Если соответствие не задано, CS-Cart будет считать, что такого склада пока не существует, и создаст новый.

  .. important::

      Допустим, вы добавили новый магазин или склад на стороне учётной системы. Тогда после первого его импорта по CommerceML загляните в настройки этой точки в CS-Cart и задайте там тарифные зоны. Иначе количество с этой точки никому не будет доступно для покупки.

===========================================================
Сколько товаров можно купить, если количество везде разное?
===========================================================

Зависит от того, как вы настроите склады и CS-Cart. Возможных сочетаний очень много: разрешено ли отрицательное количество товаров в наличии, разрешён ли предзаказ товара, если его в наличии нет, и т.п. Поэтому здесь мы расскажем только о принципе, по которому считается доступное количество. Есть два основных сценария.

**Сценарий 1:** *Любой может купить всё, что есть, независимо от местонахождения.* Чтобы реализовать такой сценарий, достаточно всем магазинам и складам поставить галку "Доставка в" для всех тарифных зон.

**Сценарий 2:** *Доступное количество зависит от местонахождения покупателя.* В этом случае доступное для покупки количество будет зависеть от:

  * тарифной зоны покупателя (определяется либо по информации из профиля, либо по геолокации);

  * количества на складах и в магазинах, которые доставляют в тарифную зону.
  
  .. hint::
    Для определения страны по IP-адресу мы используем базы данных GeoLite2 от MaxMind, доступные на `https://www.maxmind.com <https://www.maxmind.com/>`_.

Например, посмотрите на картинку ниже. Там магазин настроен так, что товары с него доступны во всех возможных тарифных зонах.

.. important::

    Доступное количество равняется сумме количеств со всех магазинов и складов, которые доставляют в тарифную зону.

.. fancybox:: img/warehouse_settings.png
    :alt: Склад, который работает с Россией, но не работает с другими странами. Товары с него будут доступны только для покупателей из России.

==============================================
Где и как задать количество товаров на складе?
==============================================

#. На :doc:`странице редактирования товара </user_guide/manage_products/products/add_product>` есть вкладка "Количество". Там отображаются все магазины и склады, и можно задать количество на них. Там есть три возможных варианта:

   * *Любое количество кроме 0* — товар в наличии на этой точке.

   * *0* — товара нет в наличии на этой точке.

   * *Пустое поле* — магазин не отобразится в списке доступных магазинов на странице товара.

   .. important::

       Если у товара задано количество (даже 0) на любом складе или магазине, то общее количество редактировать нельзя. Оно будет суммироваться со всех магазинов/складов. При этом старое значение общего количества никуда не теряется. Оно вернётся, если выключить модуль :doc:`"Склады" <index>` или убрать у товара количество со всех складов.

   .. fancybox:: img/warehouse_quantity.png
       :alt: Редактирование количества товара по складам.

#. Количество на складах и в магазинах можно экспортировать и импортировать.

   * При :doc:`экспорте товаров </user_guide/manage_products/import_export/product_export>` (в том числе через :doc:`конструктор прайс-листов </user_guide/addons/data_feeds/create_df>`) количество товаров на конкретном магазине или складе выгружается в полях вида *[Название магазина/склада] (Склад)*.

   * При :doc:`импорте товаров </user_guide/manage_products/import_export/advanced_product_import>` при выборе соответствия полей есть раздел "Количество" с названиями магазинов и складов. Так можно импортировать количество для разных магазинов/складов.

#. Если включен модуль :doc:`CommerceML </user_guide/addons/commerceml/index>`, то склады и количество на них берутся из файла *offers.xml*.

   .. important::

       Допустим, вы добавили новый магазин или склад на стороне учётной системы. Тогда после первого его импорта по CommerceML загляните в настройки этой точки в CS-Cart и задайте там тарифные зоны. Иначе количество с этой точки никому не будет доступно для покупки.

==============================================
С какого склада списываются товары при заказе?
==============================================

Это зависит от настроек :doc:`тарифной зоны </user_guide/shipping_and_taxes/locations/index>`, где находится покупатель. Для каждой тарифной зоны можно задать свой порядок складов. Делается это в настройках тарифной зоны, на вкладке "Магазины и склады". Перетаскивайте магазины или склады, чтобы менять порядок списания.

**Правило:** товары в первую очередь списываются с самого первого магазина или склада, который доставляет *в тарифную зону покупателя*. Если каких-то товаров из заказа на нём нет, то оставшиеся товары списываются со второго, и т.д. 

**Исключение:** при самовывозе товары в первую очередь списываются с выбранного магазина. То, чего не хватает, списывается с остальных точек, которые доставляют *в тарифную зону, где находится магазин/ПВЗ*.

.. fancybox:: img/warehouse_priority.png
    :alt: Редактирование приоритетов в рамках тарифной зоны.

===============================================================================
Почему рядом с некоторыми магазинами и складами есть предупреждение о задержке?
===============================================================================

На странице редактирования тарифной зоны есть столбец "Предупреждение о задержке". Это предупреждение появится на списке товаров, на странице товара и в корзине рядом с товаром. Но появится оно, только если выполнены *все* условия:

* покупатель из этой тарифной зоны;

* товара *нет в наличии* во всех магазинах и складах выше по списку;

* товар *в наличии* на этом магазине или складе;

* вы настроили этот магазин или склад предупреждать покупателя о задержке, когда нужно везти товары в эту тарифную зону с этой точки.

.. fancybox:: img/delay_warning.png
    :alt: Вот так выглядит предупреждение о задержке на списке товаров.

Предупреждение о задержке отображается на странице редактирования тарифной зоны, чтобы:

* помочь вам расставить магазины и склады в правильном порядке;

* показать, как будет выглядеть предупреждение, и какие магазины и склады вызывают его появление.
